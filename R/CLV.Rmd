---
title: "CLV"
output: html_notebook
---

### CLV prediction method description

New customer lifetime prediction method (**generateLifeTree()**) generates tree-like recurrent list with each node being a subscription and holding following information:

* Current customer state
* Probability of going into current node (selecting subscription of given length) from parent node if not churned (sums up to 1 for different lengths of subscription)
* Probability of churn in after current subscription (node)
* Next possible subscriptions (Children nodes)

It is generated by recurrence with *churn probability model* and *subscription length* models being parameters of the process (i.e. architecture enables quite seamless substitution of models with newer versions). Other parameters used by generator are:

* Customer to be predicted (record from **subscriptions** dataset or one generated with **initializeCustomer()**)
* Mininal absolute branch probability (probability from root to the node)
* Maximal depth of the tree
* Maximal number of months to be predicted

Example below shows generation of CLV tree:
```{r}
source('config.R')
source('utils.R')
source('utils_clv.R')

subscriptions <- read_rds('../data/subscriptions.rds')
churn_model <- read_rds('../data/models/churn_model.rds')
continuation_model <- read_rds('../data/models/continuation_model.rds')

test_customer <- initializeCustomer(marketname = 'US', paymentperiodchosenatstart = 3, months = 3, num_previous_months = 1, siteverkey = 'US')

test_customer
```

```{r}
clv_tree <- generateLifeTree(test_customer, continuation_model, churn_model, min_branch_probability = 0.001, max_depth = 2, default_length = 1, revenue = F)
str(clv_tree)
```

### Analysis available for CLV object

Currently available methods are:

* Expected lifetime
* Expected number of subscriptions
* Expected revenue (not useful until there will be a method for revenue for given market and subscription legnth)
* Sequence of most probable decisions

```{r}
test_customer_2 <- initializeCustomer(marketname = 'US', paymentperiodchosenatstart = 3, months = 1, num_previous_months = 0, siteverkey = 'US')

clv_tree_2 <- generateLifeTree(test_customer_2, continuation_model, churn_model, min_branch_probability = 0.001, revenue = F)

sprintf("Expected lifetime: %.2f months", expectedValue(clv_tree_2, type = 'lifetime'))
sprintf("Expected number of subscritions: %.2f", expectedValue(clv_tree_2, type = 'subs'))

```

```{r}
most_likely_path <- mostLikelyPath(clv_tree, omit_first_churn = T)

most_likely_path %>%
  arrange(desc(probability)) %>%
  mutate(sub = row_number()) %>%
  ggplot(aes(sub, probability, label = outcome)) +
  geom_line() +
  geom_label() +
  xlab('Number of previous subscriptions') + ylab('Probability') +
  theme_bw()
```

### Comparision of previous and current lifetime estimation method

To test its consistency with previous methodology, calculation for same customers and limitation to 1-3-3-3-3- scheme were performed.
```{r}
source('../aggregation.R')
source('../lifetimepredictor.R')

simplepredictor3m(churn_model, 'US', 'US')
```
```{r}
c('DK', 'NO', 'CH', 'FR', 'US', 'FI', 'SE', 'GB', 'NL', 'IT', 'BE', 'AU')  %>%
  walk(~{
    
    marketname <- .
    test_customer_3 <- initializeCustomer(marketname = marketname, paymentperiodchosenatstart = 3, months = 1, num_previous_months = 0, siteverkey = 'US')

    clv_tree_3 <- generateLifeTree(test_customer_3, continuation_model = NULL, churn_model, min_branch_probability = 0.001, default_length = 3, revenue = F)
    lifetime <- expectedValue(clv_tree_3, type = 'lifetime')

    print(sprintf("%s  expected lifetime:    NEW: %.5f years,     OLD: %.5f years", marketname, lifetime/12, simplepredictor3m(churn_model, marketname = marketname, 'US')))
  })
```

Below are results *without* limitation to 1-3-3-3-3- scheme:
```{r}
c('DK', 'NO', 'CH', 'FR', 'US', 'FI', 'SE', 'GB', 'NL', 'IT', 'BE', 'AU')  %>%
  walk(~{
    
    marketname <- .
    test_customer_3 <- initializeCustomer(marketname = marketname, paymentperiodchosenatstart = 3, months = 1, num_previous_months = 0, siteverkey = 'US')

    clv_tree_3 <- generateLifeTree(test_customer_3, continuation_model, churn_model, min_branch_probability = 0.001, revenue = F)
    lifetime <- expectedValue(clv_tree_3, type = 'lifetime')

    print(sprintf("%s  expected lifetime:    NEW: %.5f years,     OLD: %.5f years", marketname, lifetime/12, simplepredictor3m(churn_model, marketname = marketname, 'US')))
  })
```
This results show that taking into account that customer may change to subscriptions of different length significatnly lowers expected lifetime. 

### Additional comments

1. 24 month length subscriptions were ignored

2. Next subscription model is a very simple one:

* For first subscriprion it uses *paymentperiodchosenatstart* as predicted outcome with probability 100%
* For subsequennt subscriptions it returns historically observed probability given last subscritption's length

